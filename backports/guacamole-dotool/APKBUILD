# Contributor: Jakub Jirutka <jakub@jirutka.cz>
# Maintainer: Jakub Jirutka <jakub@jirutka.cz>
pkgname=guacamole-dotool
pkgver=0.2.0_git20231103
_gitrev=ef546927fdc8ddf059663289d0f3b15e5ef6b12a
pkgrel=0
pkgdesc="Guacamole CLI client for scripting"
url="https://github.com/jirutka/guacamole-dotool"
# riscv64,s390x: memory access out of bounds in @rollup/wasm-node
# x86: textrels
arch="all !riscv64 !s390x !x86"
# NOTE: This includes licenses of bundled npm packages.
license="MIT AND Apache-2.0 AND ISC AND BSD-3-Clause AND BSD-2-Clause"
depends="nodejs"
makedepends="
	giflib-dev
	npm
	pango-dev
	pixman-dev
	"
subpackages="$pkgname-dbg"
source="https://github.com/jirutka/guacamole-dotool/archive/$_gitrev/guacamole-dotool-$_gitrev.tar.gz"
builddir="$srcdir/$pkgname-$_gitrev"
options="net"

build() {
	npm clean-install --build-from-source
	npm run bundle
}

check() {
	rm -rf node_modules package.json
	./dist/$pkgname.mjs --help
}

package() {
	mkdir -p "$pkgdir"/usr/lib/$pkgname
	cp -r dist/* "$pkgdir"/usr/lib/$pkgname/

	cd "$pkgdir"

	strip usr/lib/$pkgname/libs/*.node

	mkdir -p usr/bin
	ln -s ../lib/$pkgname/$pkgname.mjs usr/bin/$pkgname
}

dbg() {
	depends="$pkgname=$pkgver-r$pkgrel"
	default_dbg

	amove usr/lib/$pkgname/*.map
}

sha512sums="
f05356ad7ca886d8ae089dca1bfd945c00d07c0c90e034f98469344e2e88e4fddc07c95a1b031a450545aed2a172b7278c4729d394eda611fa6095afcb940168  guacamole-dotool-ef546927fdc8ddf059663289d0f3b15e5ef6b12a.tar.gz
"
