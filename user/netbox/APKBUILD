# Maintainer: Jakub Jirutka <jakub@jirutka.cz>
pkgname=netbox
pkgver=4.2.9
pkgrel=0
pkgdesc="The premiere source of truth powering network automation"
url="https://netbox.io"
arch="noarch"
license="Apache-2.0"
# The approach is to install all python dependencies with native extensions from
# Alpine packages and the rest from PyPI.
depends="
	py3-cffi
	py3-charset-normalizer
	py3-cryptography
	py3-markupsafe
	py3-nh3>=0.2
	py3-packaging
	py3-pillow>=11
	py3-psycopg-c~3
	py3-psycopg-pool~3
	py3-regex
	py3-rpds-py
	py3-tzdata
	py3-yaml
	python3
	uwsgi-http
	uwsgi-python3
	uwsgi-syslog
	"
pkgusers="netbox"
pkggroups="netbox"
install="
	$pkgname.pre-install
	$pkgname.post-install
	$pkgname.post-upgrade
	"
subpackages="$pkgname-openrc"
source="https://github.com/netbox-community/netbox/archive/v$pkgver/$pkgname-$pkgver.tar.gz
	configuration-defaults.patch
	social_core-jwt-leeway.patch.txt
	settings.patch
	$pkgname.initd
	$pkgname.confd
	$pkgname-rq.initd
	$pkgname-rq.confd
	$pkgname.logrotated
	netbox-housekeeping.daily
	netbox-manage
	uwsgi.ini
	"
options="!check"

_appdir="usr/lib/$pkgname"

prepare() {
	default_prepare

	# Relax version requirements for modules we don't install into venv,
	# but use system-provided.
	# We use uWSGI instead of gunicorn.
	sed -Ei \
		-e 's/^(nh3)[>=]=(\d+\.\d+).*/\1>=\2/' \
		-e 's/^(Pillow)[>=]=(\d+).*/\1>=\2/' \
		-e 's/^(PyYAML)[>=]=(\d+).*/\1>=\2/' \
		-e 's/^(psycopg\[[^]]*\])[>=]=(\d+).*/\1>=\2/' \
		-e 's/^tzdata==.*/tzdata/' \
		-e '/^gunicorn\b/d' \
		requirements.txt

	sed -i '/netbox\.tests\.dummy_plugin/d' netbox/netbox/configuration_testing.py

	mv netbox/manage.py netbox/netbox-manage
}

build() {
	# Create virtualenv.
	python3 -m venv --system-site-packages .

	# Install dependencies.
	bin/python3 -m pip install \
		--disable-pip-version-check \
		--isolated \
		--no-cache-dir \
		--no-compile \
		--no-input \
		--require-virtualenv \
		--verbose \
		-r requirements.txt

	patch -p1 -d lib/python3.*/site-packages < "$srcdir"/social_core-jwt-leeway.patch.txt


	## Clean-up

	# Remove some useless files.
	find lib -type d -name tests -exec rm -Rfv '{}' +
	find lib \( \
		-name '*.bak' -o \
		-name 'test_*.py' -o \
		-name 'test_*.pyc' -o \
		-name 'README*' -o \
		-name 'LICENSE*' \) -delete
	rm bin/activate* bin/Activate*
	rm netbox/generate_secret_key.py
	rm -rfv netbox/*/tests
	rm -rf include lib64 share

	# Remove non-English locales.
	find lib/python*/site-packages/django/conf/locale \
		lib/python*/site-packages/django/contrib/*/locale \
		-type d ! -name en -mindepth 1 -maxdepth 1 -exec rm -rf '{}' \;
	find lib/python*/site-packages/babel/locale-data \
		-type f ! \( -name en.dat -or -iname en_US*.dat -o -iname en_[0-1]*.dat \) \
		-delete
	find netbox/translations \
		-type d ! -name en -mindepth 1 -maxdepth 1 -exec rm -rf '{}' \;


	## Compile static assets

	mv netbox/netbox/configuration_testing.py netbox/netbox/configuration.py

	bin/python3 bin/mkdocs build
	PATH="$PWD/bin:$PATH" netbox/netbox-manage collectstatic --noinput --clear

	rm netbox/netbox/configuration.py


	## Finalize

	# Remove build-time dependencies.
	bin/python3 -m pip uninstall --disable-pip-version-check -y \
		mkdocs \
		mkdocs-material \
		mkdocstrings \
		pip

	# .map files are not needed for production.
	find netbox/static -name '*.map' -delete
	# EOT and TTF fonts are needed only for ancient browsers.
	find netbox/static \( -name '*.eot' -o -name '*.ttf' \) -delete

	# Compress assets bigger than 16 kiB.
	find netbox/static -size +16k \
		\( -name '*.css' -o -name '*.js' -o -name '*.svg' \) \
		-exec gzip -k9 {} \;

	# Source static assets are not needed anymore.
	rm -rf netbox/project-static
	rm -rf lib/python*/site-packages/*/static
	rm -rf lib/python*/site-packages/django/contrib/static
	rm -rf lib/python*/site-packages/django/contrib/*/static
	rm -rf lib/python*/site-packages/material/.icons

	# Fix absolute paths e.g. in shebang to the correct destination.
	find ./bin -type f -exec sed -i "s|$builddir|/$_appdir|g" {} \;

	# Regenerate .pyc files with correct paths.
	bin/python3 -m compileall -f -q -d "/$_appdir"/lib lib
}

package() {
	mkdir -p "$pkgdir/$_appdir"
	cp -r bin \
		lib \
		netbox \
		pyvenv.cfg \
		requirements.txt \
		"$pkgdir/$_appdir"/

	install -D -m644 "$srcdir"/uwsgi.ini -t "$pkgdir"/etc/$pkgname/
	install -D -m640 -o root -g netbox netbox/netbox/configuration_example.py \
		"$pkgdir"/etc/$pkgname/configuration.py

	cd "$pkgdir"

	ln -s /etc/$pkgname/configuration.py $_appdir/netbox/netbox/configuration.py
	ln -s /etc/$pkgname/secret_key.txt $_appdir/netbox/netbox/secret_key.txt

	install -D -m755 "$srcdir"/netbox-manage -t usr/bin/

	install -D -m755 "$srcdir"/$pkgname.initd etc/init.d/$pkgname
	install -D -m644 "$srcdir"/$pkgname.confd etc/conf.d/$pkgname

	install -D -m755 "$srcdir"/$pkgname-rq.initd etc/init.d/$pkgname-rq
	install -D -m644 "$srcdir"/$pkgname-rq.confd etc/conf.d/$pkgname-rq

	install -D -m644 "$srcdir"/$pkgname.logrotated etc/logrotate.d/$pkgname
	install -D -m755 "$srcdir"/netbox-housekeeping.daily etc/periodic/daily/netbox-housekeeping

	install -d -m750 -o netbox -g netbox \
		var/lib/$pkgname/media \
		var/lib/$pkgname/reports \
		var/lib/$pkgname/scripts \
		var/log/$pkgname
}

sha512sums="
8f466efda99fdfc55e332bb2624cb3e171c81a95249cfe48ac169bc7569f5d982ac08ae2e6e745c5aae1ee652fc92991f673869a3a8c503f60b6f464183588b4  netbox-4.2.9.tar.gz
432e3f386d012c3222a825db67bb4d298680d0ed092496cd6b7c07a499f493065c525b23185920391f6e378178c044e6bf574b331a051a2cef5fd058d3b8598b  configuration-defaults.patch
2bf324435d5fe23179bfe5b5d2f7de5fcd0e359d83f6ee225b39d33b0b0d2eeb91096c0329074d41378f3d22b007f614666d464cf1d32b0e6ad2e7ba88d9fff5  social_core-jwt-leeway.patch.txt
ef1db6691271961c95a7da9ed573dd78f08485d4b3d5de18534be46e0710d1e476b27b1c33ce1d5fb4524b4fc2a669bc2a8ed3b07237ac2254098029230bc918  settings.patch
fe30731de9c84ba95fa36a5599d5dd656d4af5a62b5dcca638050f67b6f76dbb56bf0f4b78a6fcd4b17745bfcdd0bdafd6e242839ed2f422df8cdd922cdceb75  netbox.initd
f724709c0f6253631381db950912245e4918faac7da64eeb0139810e4f50cfb81d7c58d5351c57c51b7feed5402593b2fa0ec32024dea83a356bba83564fa239  netbox.confd
d9a48e2768f7f3f88d5f254cc6b6aced247cbb49843bc7e6afe7d2a2a2d81c5bef9d9cf84ca4b4cf80a155cb93e5bf4978f7859b11a0f6de0b24cb85cc3d57f8  netbox-rq.initd
4fc0694907310d260c7a2f86f70bb2fe93e0dce5f7fd734dba0af4a3339146f43691e5c4afe0e0c81a615e19ee58e68f35fc4edef109deb69a36ca5b4a53634d  netbox-rq.confd
738f419d5b697176a1972a0ccbbb59a45a0afa053d2fdef79a5bef035ea8acb0f0bd79a378f1eaf477fe85fb5e46348693b2712aa85a7afe7b84e336730ae36f  netbox.logrotated
a346248aa0e7d36e70e31b7f6e0183f85d784fbc5e97b49e12127812db63444a0a642df0888d65ec7c4f11fdc552195badd9e545cbe5afad9968c572ca82fa6d  netbox-housekeeping.daily
f2f2219aee45ad1bee17af103861872b8e532afa6456342d0e27800e1aab4a3a33a65956135c6882c09baae6eb63cf00cfec3735cd848fc77d3e7676d8a3effe  netbox-manage
da97cae94aa6a948466b329e300f7da3135639168472c9dd423caef862ebe28b5a9fff481ba4c820b28f2a5e5a11f79037635a0b597116d0b569883c464df1d8  uwsgi.ini
"
